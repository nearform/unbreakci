name: deploy-app

on:
  workflow_call:
    inputs:
      env:
        required: true
        type: string
      app_id_github:
        required: true
        type: string
      pr_author:
        required: true
        type: string
      project_number:
        required: true
        type: string
      column_name:
        required: true
        type: string
      webhook_path:
        required: true
        type: string
      project_id:
        required: true
        type: string

    secrets:
      gcp_provider_name:
        required: true
      gcp_sa:
        required: true
      gcp_webhook_secret:
        required: true
      gcp_app_key:
        required: true

jobs:
    deploy:
        name: Setup Gcloud Account
        permissions:
          id-token: write
          contents: read
        runs-on: ubuntu-latest
        env:
          gcp_service_region: us-central1

        steps:
        - name: Deploy New App Version
          uses: actions/checkout@v3
          with:
            ref: ${{ github.head_ref }}

        - name: GCP Authentication
          id: auth
          uses: 'google-github-actions/auth@v1'
          with:
            token_format: 'access_token'
            workload_identity_provider: ${{ secrets.gcp_provider_name }}
            service_account: ${{ secrets.gcp_sa }}

        - name: Update secrets in GCP Secret Manager
          uses: nearform-actions/github-action-gcp-secrets@v1
          with:
            secrets: |-
              unbreak_${{ inputs.env }}_webhook_secret:"${{ secrets.gcp_webhook_secret }}"
              unbreak_${{ inputs.env }}_app_key:"${{ secrets.gcp_app_key }}"

        - name: 'Deploy webhook to Cloud Run'
          id: deploy-webhook
          run: >-
            gcloud functions deploy ${{ inputs.webhook_path }}
            --project="${{ inputs.gcp_project_id }}"
            --runtime=nodejs18
            --source=.
            --entry-point=webhook
            --set-secrets=APP_KEY=projects/${{ inputs.gcp_project_id }}/secrets/unbreak_${{ inputs.env }}_app_key:latest
            --set-secrets=WEBHOOK_SECRET=projects/${{ inputs.gcp_project_id }}/secrets/unbreak_${{ inputs.env }}_webhook_secret:latest
            --set-env-vars=APP_ID="${{ inputs.APP_ID_GITHUB  }}"
            --set-env-vars=PR_AUTHOR="${{ inputs.pr_author }}"
            --set-env-vars=PROJECT_NUMBER="${{ inputs.project_number }}"
            --set-env-vars=COLUMN_NAME="${{ inputs.column_name }}"
            --set-env-vars=LOG_LEVEL=info
            --trigger-http
            --allow-unauthenticated
            --region=us-central1
            --gen2
